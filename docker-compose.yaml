version: '3'
services:
    jaeger-all-in-one:
        image: jaegertracing/all-in-one:latest
        restart: always
        ports:
            - '16686:16686'
            - '14268'
            - '14250'
        networks:
            - mynetwork

    zipkin:
        image: openzipkin/zipkin:latest
        restart: always
        ports:
        - "9411:9411"
        networks:
            - mynetwork        
        healthcheck:
            test: ["CMD-SHELL", "wget --spider --no-verbose --tries=1 --timeout=5 http://localhost:9411/health || exit 1"]
            start_interval: 2s
            interval: 10s
            timeout: 5s
            retries: 3
    otel-collector:
        image: otel/opentelemetry-collector:latest
        restart: always
        command: ['--config=/etc/otel-collector-config.yaml']
        volumes:
            - ./.docker/otel-collector-config.yaml:/etc/otel-collector-config.yaml
        ports:
            - '4317:4317' # OTLP gRPC receiver -> porta principal
            - '55679:55679' # zpages extension
        networks:
            - mynetwork
    cep:
        container_name: cep
        build:
            context: ./cep
        env_file:
            - ./cep/.env
        ports:
            - 8080:8080
        depends_on:
            - jaeger-all-in-one
            - otel-collector
            - zipkin
        networks:
            - mynetwork
    # weather:
    #     container_name: weather
    #     build:
    #         context: ./weather
    #     env_file:
    #         - ./weather/.env
    #     ports:
    #         - 50051:50051
    #     depends_on:
    #         - jaeger-all-in-one
    #         - otel-collector
    #         - zipkin
    #         - cep
    #     networks:
    #         - mynetwork
networks:
    mynetwork:
        driver: bridge
